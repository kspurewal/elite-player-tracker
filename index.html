
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <title>Elite Player Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a1a;
      color: #e0e0e0;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      border-bottom: 3px solid #4ade80;
      padding: 24px 0;
      text-align: center;
    }

    .header-logo {
      width: 120px;
      height: 120px;
      margin: 0 auto 12px;
      border-radius: 50%;
      object-fit: cover;
    }

    header h1 {
      font-size: 2.4rem;
      font-weight: 800;
      letter-spacing: 2px;
      color: #fff;
    }

    header h1 span {
      color: #4ade80;
    }

    header p {
      color: #8892b0;
      margin-top: 6px;
      font-size: 0.95rem;
    }

    .subtitle {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .subtitle .badge {
      background: rgba(74, 222, 128, 0.15);
      border: 1px solid #4ade80;
      color: #4ade80;
      padding: 4px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .subtitle .week-label {
      color: #8892b0;
      font-size: 0.85rem;
    }

    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .top25-heading {
      text-align: center;
      font-size: 1.8rem;
      font-weight: 700;
      color: #ef4444;
      margin-bottom: 20px;
    }

    .formula-box {
      background: #1a1a2e;
      border: 1px solid #2a2a4a;
      border-radius: 10px;
      padding: 16px 20px;
      margin-bottom: 28px;
      text-align: center;
    }

    .formula-box h3 {
      color: #4ade80;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 8px;
    }

    .formula-box p {
      color: #8892b0;
      font-size: 0.82rem;
      font-family: monospace;
    }

    .top-player-box {
      background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
      border: 2px solid #ffd700;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 28px;
      text-align: center;
      display: none;
    }

    .top-player-box .crown {
      font-size: 2rem;
      margin-bottom: 6px;
    }

    .top-player-box .tp-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #ffd700;
      margin-bottom: 8px;
    }

    .top-player-box .tp-name {
      font-size: 1.6rem;
      font-weight: 800;
      color: #fff;
    }

    .top-player-box .tp-team {
      font-size: 0.85rem;
      color: #8892b0;
      margin-top: 4px;
    }

    .top-player-box .tp-ept {
      font-size: 2rem;
      font-weight: 800;
      color: #4ade80;
      margin-top: 12px;
    }

    .top-player-box .tp-ept span {
      font-size: 0.8rem;
      font-weight: 400;
      color: #8892b0;
    }

    .top-player-box .tp-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .top-player-box .tp-stat {
      color: #b0b0d0;
      font-size: 0.85rem;
    }

    .top-player-box .tp-stat strong {
      color: #fff;
    }

    .stat-leaders {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-bottom: 28px;
    }

    .stat-leader-card {
      background: #1a1a2e;
      border: 1px solid #2a2a4a;
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }

    .stat-leader-card .sl-category {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #8892b0;
      margin-bottom: 8px;
    }

    .stat-leader-card .sl-value {
      font-size: 1.4rem;
      font-weight: 800;
      color: #4ade80;
    }

    .stat-leader-card .sl-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: #fff;
      margin-top: 6px;
    }

    .stat-leader-card .sl-sub {
      font-size: 0.7rem;
      color: #6a6a9a;
      margin-top: 2px;
    }

    .stat-leader-card .sl-team {
      font-size: 0.7rem;
      color: #6a6a9a;
      margin-top: 2px;
    }

    @media (max-width: 700px) {
      .stat-leaders {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #8892b0;
    }

    .loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #2a2a4a;
      border-top-color: #4ade80;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-msg {
      text-align: center;
      padding: 40px 20px;
      color: #4ade80;
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 10px;
    }

    .error-msg button {
      margin-top: 12px;
      background: #4ade80;
      color: #fff;
      border: none;
      padding: 8px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .error-msg button:hover {
      background: #38b866;
    }

    /* Table */
    .player-table {
      width: 100%;
      border-collapse: collapse;
      background: #12122a;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .player-table thead {
      background: #1a1a2e;
    }

    .player-table th {
      padding: 14px 12px;
      text-align: center;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #8892b0;
      border-bottom: 2px solid #4ade80;
    }

    .player-table th:nth-child(1),
    .player-table th:nth-child(2) {
      text-align: left;
    }

    .player-table td {
      padding: 12px;
      text-align: center;
      font-size: 0.9rem;
      border-bottom: 1px solid #1e1e3a;
    }

    .player-table td:nth-child(1),
    .player-table td:nth-child(2) {
      text-align: left;
    }

    .player-table tbody tr.player-row {
      transition: background 0.15s;
      cursor: pointer;
    }

    .player-table tbody tr.player-row:hover {
      background: rgba(74, 222, 128, 0.06);
    }

    .player-table tbody tr.detail-row {
      display: none;
    }

    .player-table tbody tr.detail-row.open {
      display: table-row;
    }

    .player-table tbody tr.detail-row td {
      padding: 0;
      border-bottom: 2px solid #2a2a4a;
    }

    .detail-content {
      background: #0e0e22;
      padding: 16px 20px;
    }

    .detail-content h4 {
      color: #4ade80;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 12px;
    }

    .detail-grid {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .detail-grid .detail-item {
      background: #1a1a2e;
      border: 1px solid #2a2a4a;
      border-radius: 8px;
      padding: 10px 16px;
      text-align: center;
      min-width: 80px;
      flex: 1;
    }

    .detail-item .di-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #8892b0;
      margin-bottom: 4px;
    }

    .detail-item .di-value {
      font-size: 1.05rem;
      font-weight: 700;
      color: #fff;
    }

    .detail-item .di-sub {
      font-size: 0.7rem;
      color: #6a6a9a;
      margin-top: 2px;
    }

    /* Rank column */
    .rank {
      font-weight: 700;
      color: #8892b0;
      width: 40px;
      padding-left: 16px !important;
    }

    .rank-1 { color: #ffd700; }
    .rank-2 { color: #c0c0c0; }
    .rank-3 { color: #cd7f32; }

    /* Player name */
    .player-name {
      font-weight: 600;
      color: #fff;
    }

    .player-team {
      font-size: 0.75rem;
      color: #6a6a9a;
      margin-top: 2px;
    }

    /* EPT rating column */
    .ept-rating {
      font-weight: 700;
      color: #4ade80;
      font-size: 1rem;
    }

    /* Stat values */
    .stat-val {
      color: #b0b0d0;
    }

    /* Last updated */
    .last-updated {
      text-align: center;
      margin-top: 20px;
      color: #5a5a7a;
      font-size: 0.78rem;
    }

    /* Responsive */
    @media (max-width: 700px) {
      header h1 { font-size: 1.6rem; }
      .player-table { font-size: 0.8rem; }
      .player-table th, .player-table td { padding: 8px 6px; }
      .hide-mobile { display: none; }
    }
  </style>
</head>
<body>

  <header>
    <img src="logo.png" alt="EPT Logo" class="header-logo">
    <h1><span>E</span>LITE <span>P</span>LAYER <span>T</span>RACKER</h1>
    <p>The best NBA players, ranked by EPT Rating. KRISH</p>
    <div class="subtitle">
      <span class="badge">NBA</span>
      <span class="week-label" id="week-label">Loading week...</span>
    </div>
  </header>

  <main>
    <h2 class="top25-heading">Top 25 Players</h2>
    <div class="formula-box">
      <h3>EPT Rating Formula</h3>
      <p>(PTS &times; 1.5) + (REB &times; 1.5) + (AST &times; 1.5) + (STL &times; 3) + (BLK &times; 3) &minus; (TO &times; 1.5)</p>
    </div>

    <div id="top-player" class="top-player-box"></div>

    <div id="stat-leaders" class="stat-leaders" style="display:none;"></div>

    <div id="content">
      <div class="loading">
        <div class="spinner"></div>
        <p>Fetching NBA stats...</p>
      </div>
    </div>

    <div class="last-updated" id="last-updated"></div>
  </main>

  <script>
    function formatDateNice(dateStr) {
      const d = new Date(dateStr + "T00:00:00");
      return d.toLocaleDateString("en-US", { month: "short", day: "numeric" });
    }

    function avg(val, gp) { return gp ? +(val / gp).toFixed(1) : 0; }

    function renderTable(players) {
      // Ensure per-game and pct fields exist (computed client-side as fallback)
      players.forEach(p => {
        if (p.ppg == null) p.ppg = avg(p.pts, p.gp);
        if (p.rpg == null) p.rpg = avg(p.reb, p.gp);
        if (p.apg == null) p.apg = avg(p.ast, p.gp);
        if (p.spg == null) p.spg = avg(p.stl, p.gp);
        if (p.bpg == null) p.bpg = avg(p.blk, p.gp);
        if (p.topg == null) p.topg = avg(p.tov, p.gp);
        if (p.fgPct == null) p.fgPct = 0;
        if (p.tpPct == null) p.tpPct = 0;
        if (p.ftPct == null) p.ftPct = 0;
        if (p.fgm == null) p.fgm = 0;
        if (p.fga == null) p.fga = 0;
        if (p.fg3m == null) p.fg3m = 0;
        if (p.fg3a == null) p.fg3a = 0;
        if (p.ftm == null) p.ftm = 0;
        if (p.fta == null) p.fta = 0;
      });

      let html = `
        <table class="player-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Player</th>
              <th>GP</th>
              <th>PTS</th>
              <th>REB</th>
              <th>AST</th>
              <th class="hide-mobile">STL</th>
              <th class="hide-mobile">BLK</th>
              <th class="hide-mobile">TO</th>
              <th>EPT Points</th>
            </tr>
          </thead>
          <tbody>
      `;

      const colCount = 10;

      for (let i = 0; i < players.length; i++) {
        const p = players[i];
        const rank = i + 1;
        let rankClass = "";
        if (rank === 1) rankClass = "rank-1";
        else if (rank === 2) rankClass = "rank-2";
        else if (rank === 3) rankClass = "rank-3";

        html += `
          <tr class="player-row" data-index="${i}">
            <td class="rank ${rankClass}">${rank}</td>
            <td>
              <div class="player-name">${p.name}</div>
              <div class="player-team">${p.team}</div>
            </td>
            <td class="stat-val">${p.gp}</td>
            <td class="stat-val">${p.pts}</td>
            <td class="stat-val">${p.reb}</td>
            <td class="stat-val">${p.ast}</td>
            <td class="stat-val hide-mobile">${p.stl}</td>
            <td class="stat-val hide-mobile">${p.blk}</td>
            <td class="stat-val hide-mobile">${p.tov}</td>
            <td class="ept-rating">${p.ept}</td>
          </tr>
          <tr class="detail-row" data-index="${i}">
            <td colspan="${colCount}">
              <div class="detail-content">
                <h4>${p.name} â€” ${p.team}</h4>
                <div class="detail-grid">
                  <div class="detail-item">
                    <div class="di-label">FG%</div>
                    <div class="di-value">${p.fgPct}%</div>
                    <div class="di-sub">${p.fgm}/${p.fga}</div>
                  </div>
                  <div class="detail-item">
                    <div class="di-label">3P%</div>
                    <div class="di-value">${p.tpPct}%</div>
                    <div class="di-sub">${p.fg3m}/${p.fg3a}</div>
                  </div>
                  <div class="detail-item">
                    <div class="di-label">FT%</div>
                    <div class="di-value">${p.ftPct}%</div>
                    <div class="di-sub">${p.ftm}/${p.fta}</div>
                  </div>
                  <div class="detail-item">
                    <div class="di-label">PPG</div>
                    <div class="di-value">${p.ppg}</div>
                  </div>
                  <div class="detail-item">
                    <div class="di-label">RPG</div>
                    <div class="di-value">${p.rpg}</div>
                  </div>
                  <div class="detail-item">
                    <div class="di-label">APG</div>
                    <div class="di-value">${p.apg}</div>
                  </div>
                  <div class="detail-item">
                    <div class="di-label">SPG</div>
                    <div class="di-value">${p.spg}</div>
                  </div>
                  <div class="detail-item">
                    <div class="di-label">BPG</div>
                    <div class="di-value">${p.bpg}</div>
                  </div>
                  <div class="detail-item">
                    <div class="di-label">TOPG</div>
                    <div class="di-value">${p.topg}</div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        `;
      }

      html += `</tbody></table>`;
      return html;
    }

    // Get NBA season string
    function getNBASeason() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const startYear = month >= 9 ? year : year - 1;
      const endYear = (startYear + 1) % 100;
      return `${startYear}-${String(endYear).padStart(2, "0")}`;
    }

    // Calculate EPT
    function calcEPT(pts, reb, ast, stl, blk, tov) {
      return +(pts * 1.5 + reb * 1.5 + ast * 1.5 + stl * 3 + blk * 3 - tov * 1.5).toFixed(1);
    }

    // Fetch stats directly from NBA (works on GitHub Pages via CORS proxy)
    async function fetchNBAStats() {
      const season = getNBASeason();
      const nbaUrl = `https://stats.nba.com/stats/leagueLeaders?ActiveFlag=&LeagueID=00&PerMode=Totals&Scope=S&Season=${season}&SeasonType=Regular+Season&StatCategory=PTS`;

      // Try direct fetch first (works locally with server), then try CORS proxy for GitHub Pages
      let resp;
      try {
        resp = await fetch("/api/stats");
        if (resp.ok) {
          return await resp.json();
        }
      } catch (e) {
        // Local server not running, use CORS proxy
      }

      // Try multiple CORS proxies as fallback for GitHub Pages
      const proxies = [
        `https://api.allorigins.win/raw?url=${encodeURIComponent(nbaUrl)}`,
        `https://corsproxy.io/?${encodeURIComponent(nbaUrl)}`,
        `https://proxy.cors.sh/${nbaUrl}`,
      ];

      let lastError;
      for (const proxyUrl of proxies) {
        try {
          resp = await fetch(proxyUrl, {
            headers: {
              'Origin': window.location.origin
            }
          });
          if (resp.ok) break;
        } catch (e) {
          lastError = e;
        }
      }

      if (!resp || !resp.ok) throw new Error(`Could not fetch NBA stats. Try refreshing.`);

      const nbaData = await resp.json();
      const headers = nbaData.resultSet.headers;
      const rows = nbaData.resultSet.rowSet;

      const idx = {};
      headers.forEach((h, i) => (idx[h] = i));

      const players = rows.map((r) => {
        const gp = r[idx["GP"]] ?? 0;
        const pts = r[idx["PTS"]] ?? 0;
        const reb = r[idx["REB"]] ?? 0;
        const ast = r[idx["AST"]] ?? 0;
        const stl = r[idx["STL"]] ?? 0;
        const blk = r[idx["BLK"]] ?? 0;
        const tov = r[idx["TOV"]] ?? 0;
        const fgm = r[idx["FGM"]] ?? 0;
        const fga = r[idx["FGA"]] ?? 0;
        const fg3m = r[idx["FG3M"]] ?? 0;
        const fg3a = r[idx["FG3A"]] ?? 0;
        const ftm = r[idx["FTM"]] ?? 0;
        const fta = r[idx["FTA"]] ?? 0;
        const fgPct = r[idx["FG_PCT"]] ?? (fga ? fgm / fga : 0);
        const ftPct = r[idx["FT_PCT"]] ?? (fta ? ftm / fta : 0);
        const tpPct = r[idx["FG3_PCT"]] ?? (fg3a ? fg3m / fg3a : 0);

        return {
          name: r[idx["PLAYER"]],
          team: r[idx["TEAM"]],
          gp, pts, reb, ast, stl, blk, tov,
          fgm, fga, fg3m, fg3a, ftm, fta,
          fgPct: +(fgPct * 100).toFixed(1),
          ftPct: +(ftPct * 100).toFixed(1),
          tpPct: +(tpPct * 100).toFixed(1),
          ppg: gp ? +(pts / gp).toFixed(1) : 0,
          rpg: gp ? +(reb / gp).toFixed(1) : 0,
          apg: gp ? +(ast / gp).toFixed(1) : 0,
          spg: gp ? +(stl / gp).toFixed(1) : 0,
          bpg: gp ? +(blk / gp).toFixed(1) : 0,
          topg: gp ? +(tov / gp).toFixed(1) : 0,
          ept: calcEPT(pts, reb, ast, stl, blk, tov),
        };
      });

      players.sort((a, b) => b.ept - a.ept);

      return {
        players: players.slice(0, 25),
        season,
        updatedAt: new Date().toISOString(),
      };
    }

    async function main() {
      const contentEl = document.getElementById("content");
      const weekLabel = document.getElementById("week-label");
      const updatedEl = document.getElementById("last-updated");

      try {
        const data = await fetchNBAStats();

        if (data.error) throw new Error(data.error);

        weekLabel.textContent = `${data.season || getNBASeason()} Season`;

        if (!data.players || data.players.length === 0) {
          contentEl.innerHTML = `
            <div class="error-msg">
              <p>No games found for this week yet. Check back later!</p>
            </div>
          `;
          return;
        }

        // Show stat leader boxes
        const slEl = document.getElementById("stat-leaders");
        const categories = [
          { key: "pts", label: "Most Points" },
          { key: "reb", label: "Most Rebounds" },
          { key: "ast", label: "Most Assists" },
          { key: "blk", label: "Most Blocks" },
          { key: "stl", label: "Most Steals" },
          { key: "tov", label: "Most Turnovers" },
          { key: "fgPct", label: "Highest FG%", suffix: "%", made: "fgm", attempted: "fga" },
          { key: "ftPct", label: "Highest FT%", suffix: "%", made: "ftm", attempted: "fta" },
          { key: "tpPct", label: "Highest 3P%", suffix: "%", made: "fg3m", attempted: "fg3a" },
        ];
        let slHtml = "";
        for (const cat of categories) {
          const leader = data.players.reduce((best, p) => p[cat.key] > best[cat.key] ? p : best, data.players[0]);
          const displayVal = cat.suffix ? leader[cat.key] + cat.suffix : leader[cat.key];
          const fractionHtml = cat.made ? `<div class="sl-sub">${leader[cat.made]}/${leader[cat.attempted]}</div>` : "";
          slHtml += `
            <div class="stat-leader-card">
              <div class="sl-category">${cat.label}</div>
              <div class="sl-value">${displayVal}</div>
              ${fractionHtml}
              <div class="sl-name">${leader.name}</div>
              <div class="sl-team">${leader.team}</div>
            </div>
          `;
        }
        slEl.innerHTML = slHtml;
        slEl.style.display = "grid";

        // Show top player box
        const topEl = document.getElementById("top-player");
        const top = data.players[0];
        topEl.style.display = "block";
        topEl.innerHTML = `
          <div class="crown">ðŸ‘‘</div>
          <div class="tp-label">#1 Player</div>
          <div class="tp-name">${top.name}</div>
          <div class="tp-team">${top.team}</div>
          <div class="tp-ept">${top.ept} <span>EPT</span></div>
          <div class="tp-stats">
            <div class="tp-stat"><strong>${top.pts}</strong> PTS</div>
            <div class="tp-stat"><strong>${top.reb}</strong> REB</div>
            <div class="tp-stat"><strong>${top.ast}</strong> AST</div>
            <div class="tp-stat"><strong>${top.stl}</strong> STL</div>
            <div class="tp-stat"><strong>${top.blk}</strong> BLK</div>
          </div>
        `;

        contentEl.innerHTML = renderTable(data.players);

        // Add click-to-expand handlers
        contentEl.querySelectorAll(".player-row").forEach(row => {
          row.addEventListener("click", () => {
            const idx = row.dataset.index;
            const detail = contentEl.querySelector(`.detail-row[data-index="${idx}"]`);
            detail.classList.toggle("open");
          });
        });

        updatedEl.textContent = `Last updated: ${new Date(data.updatedAt).toLocaleString()}`;

      } catch (err) {
        console.error(err);
        contentEl.innerHTML = `
          <div class="error-msg">
            <p>Could not load stats. Please try again.</p>
            <p style="font-size:0.8rem; margin-top:8px;">${err.message}</p>
            <button onclick="location.reload()">Try Again</button>
          </div>
        `;
      }
    }

    main();

    // Auto-refresh every 5 minutes
    setInterval(main, 5 * 60 * 1000);
  </script>

</body>
</html>
